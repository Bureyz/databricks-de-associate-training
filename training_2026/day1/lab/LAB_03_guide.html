<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title> </title>
  <style>
    /* Default styles provided by pandoc.
    ** See https://pandoc.org/MANUAL.html#variables-for-html for config info.
    */
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      border: none;
      border-top: 1px solid #1a1a1a;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>

<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 0 20px; color: #333; line-height: 1.6; }
  h1 { color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 8px; }
  h2 { color: #2d2d2d; border-bottom: 1px solid #ddd; padding-bottom: 6px; margin-top: 30px; }
  h3 { color: #444; margin-top: 20px; }
  code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }
  pre { background: #f5f5f5; padding: 16px; border-radius: 6px; overflow-x: auto; border: 1px solid #e0e0e0; }
  pre code { background: none; padding: 0; }
  table { border-collapse: collapse; width: 100%; margin: 16px 0; }
  th, td { border: 1px solid #ddd; padding: 10px 14px; text-align: left; }
  th { background: #f0f4ff; font-weight: 600; }
  tr:nth-child(even) { background: #fafafa; }
  blockquote { border-left: 4px solid #1a73e8; margin: 16px 0; padding: 10px 20px; background: #f0f4ff; }
  .header { text-align: center; margin-bottom: 30px; padding: 20px; background: #f0f4ff; border-radius: 8px; }
  .header h1 { border: none; margin: 0; }
  .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #888; font-size: 0.85em; }
  @media print { body { margin: 20px; } .header { page-break-after: avoid; } }
</style>

</head>
<body>
<header id="title-block-header">
<h1 class="title"> </h1>
</header>
<h1 id="lab-03-delta-dml-time-travel">LAB 03: Delta DML &amp; Time
Travel</h1>
<p><strong>Duration:</strong> ~35 min<br />
<strong>Day:</strong> 2<br />
<strong>After module:</strong> M03: Delta Lake Fundamentals<br />
<strong>Difficulty:</strong> Intermediate</p>
<hr />
<h2 id="scenario">Scenario</h2>
<blockquote>
<p><em>“RetailHub received an updated customer list – some are new
customers, some have changed addresses. You need to merge this update
into the existing customers table. Later, someone accidentally deletes
critical records. Use Time Travel to recover them.”</em></p>
</blockquote>
<hr />
<h2 id="objectives">Objectives</h2>
<p>After completing this lab you will be able to: - Use
<code>MERGE INTO</code> to handle insert/update/delete in a single
operation - Perform <code>UPDATE</code> and <code>DELETE</code> on Delta
tables - Query historical table versions using Time Travel - Use
<code>RESTORE</code> to recover from accidental data loss - Inspect
table history with <code>DESCRIBE HISTORY</code></p>
<hr />
<h2 id="part-1-merge-into-15-min">Part 1: MERGE INTO (~15 min)</h2>
<h3 id="task-1-examine-the-update-file">Task 1: Examine the Update
File</h3>
<p>Load <code>customers_new.csv</code> and compare with the existing
Bronze customers table. How many are new vs. existing?</p>
<h3 id="task-2-merge-upsert">Task 2: MERGE (Upsert)</h3>
<p>Use <code>MERGE INTO</code> to: - <strong>UPDATE</strong> existing
customers (match on <code>customer_id</code>) with new values -
<strong>INSERT</strong> new customers that don’t exist yet</p>
<blockquote>
<p><strong>Exam Tip:</strong> MERGE supports <code>WHEN MATCHED</code>,
<code>WHEN NOT MATCHED</code>, and
<code>WHEN NOT MATCHED BY SOURCE</code> clauses. Know all three.</p>
</blockquote>
<h3 id="task-3-conditional-merge">Task 3: Conditional MERGE</h3>
<p>Modify the MERGE to only update if the email has actually changed
(add a condition to <code>WHEN MATCHED AND ...</code>).</p>
<hr />
<h2 id="part-2-update-delete-10-min">Part 2: UPDATE &amp; DELETE (~10
min)</h2>
<h3 id="task-4-update-records">Task 4: UPDATE Records</h3>
<p>Update all customers from a specific city – change their
<code>state</code> value.</p>
<h3 id="task-5-delete-records-accidental">Task 5: DELETE Records
(Accidental!)</h3>
<p>Simulate an accident:
<code>DELETE FROM customers WHERE country = 'US'</code>.</p>
<p>This will delete a significant portion of data. (We’ll fix it
next!)</p>
<hr />
<h2 id="part-3-time-travel-recovery-10-min">Part 3: Time Travel &amp;
Recovery (~10 min)</h2>
<h3 id="task-6-describe-history">Task 6: DESCRIBE HISTORY</h3>
<p>Run <code>DESCRIBE HISTORY</code> on the customers table. Observe the
versions and operations.</p>
<p>&lt;screen = DESCRIBE HISTORY output showing multiple versions:
WRITE, MERGE, UPDATE, DELETE operations with timestamps&gt;</p>
<h3 id="task-7-query-a-previous-version">Task 7: Query a Previous
Version</h3>
<p>Use <code>VERSION AS OF</code> to read the table before the
accidental delete.</p>
<h3 id="task-8-restore-the-table">Task 8: RESTORE the Table</h3>
<p>Use <code>RESTORE TABLE ... TO VERSION AS OF X</code> to undo the
accidental delete.</p>
<blockquote>
<p><strong>Exam Tip:</strong> <code>RESTORE</code> creates a new version
in the history. It doesn’t delete history – it adds a new entry. The old
versions remain accessible for further Time Travel.</p>
</blockquote>
<hr />
<h2 id="summary">Summary</h2>
<p>In this lab you: - Used MERGE INTO for upsert operations - Performed
UPDATE and DELETE on Delta tables - Queried historical versions with
Time Travel - Restored a table after accidental deletion</p>
<blockquote>
<p><strong>What’s next:</strong> LAB 04 - Optimize your Delta tables for
query performance.</p>
</blockquote>
</body>
</html>
